
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>M5Dial Final Config</title>

<style>
body {
    font-family: sans-serif;
    max-width: 420px;
    margin: auto;
    padding: 20px;
    text-align: center;
}

/* Verbinden-Button */
#connectBtn {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    border: none;
    padding: 16px 32px;
    border-radius: 12px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    margin-top: 80px;
}

#settings {
    display: none;
    margin-top: 30px;
    text-align: center;
}

/* ---------- PICKER ---------- */

.pickerWrapper {
    position: relative;
    width: 100px;
    height: 120px;  /* 3 √ó 40px */
}

.picker {
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    scrollbar-width: none;
    overscroll-behavior: contain;
}
.picker::-webkit-scrollbar { display:none; }

/* Fixer Marker */
.centerMarker {
    position: absolute;
    left: 0;
    width: 100%;
    height: 40px;
    top: 40px; /* Mitte */
    border-top: 2px solid green;
    border-bottom: 2px solid green;
    pointer-events: none;
    z-index: 10;
}

/* Items (40px hoch, zentriert) */
.item {
    height: 40px;
    position: relative;
}
.item span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 22px;
}

.picker-row {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
}

/* Timer Block */
.timer-block {
    background: #f0f0f0;
    border-radius: 12px;
    padding: 15px;
    margin-top: 25px;
}
</style>
</head>

<body>

<h1>Nachtlicht Konfigurator</h1>

<button id="connectBtn">üîó Ger√§t verbinden</button>

<div id="settings">

    <!-- SLIDER -->
    <h2>Helligkeit: <span id="valueA">0</span></h2>
    <input type="range" min="0" max="255" id="sliderA" style="width:90%;">

    <!-- TIMER 1 -->
    <div class="timer-block">
        <h2>‚è± An-Dauer</h2>
        <div class="picker-row">
            <div class="pickerWrapper">
                <div class="picker t1" id="t1h"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t1" id="t1m"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t1" id="t1s"></div>
                <div class="centerMarker"></div>
            </div>
        </div>
    </div>

    <!-- TIMER 2 -->
    <div class="timer-block">
        <h2>‚è± Langsames Ausschalten</h2>
        <div class="picker-row">
            <div class="pickerWrapper">
                <div class="picker t2" id="t2h"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t2" id="t2m"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t2" id="t2s"></div>
                <div class="centerMarker"></div>
            </div>
        </div>
    </div>

</div>

<script>
let charWrite32 = null;

const ITEM_HEIGHT = 40;


let lastSent = {0:null,1:null,2:null};

async function connectBLE() {
    // bestehender Code‚Ä¶
    notifyChar = await service.getCharacteristic(NOTIFY_UUID);
    await notifyChar.startNotifications();

    notifyChar.addEventListener("characteristicvaluechanged", e => {
        const v = e.target.value;
        const id = v.getUint8(0);
        const val = v.getUint32(1, true);

        if (val === lastSent[id]) {
            markOK(id, true);
        } else {
            markOK(id, false);
        }
    });
}

function markOK(id, ok) {
    let el = null;
    if (id === 0) el = document.querySelector("#timer1Status");
    if (id === 1) el = document.querySelector("#timer2Status");
    if (id === 2) el = document.querySelector("#sliderA");
    if (!el) return;

    el.style.color = ok ? "green" : "red";
}

    
/* ---------- BLE verbindung ---------- */
document.getElementById("connectBtn").onclick = async () => {
    const device = await navigator.bluetooth.requestDevice({
        filters: [{ name: "M5DialConfig" }],
        optionalServices: ["12345678-1234-5678-1234-56789abcdef0"]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("12345678-1234-5678-1234-56789abcdef0");

    charWrite32 = await service.getCharacteristic("11111111-1234-5678-1234-56789abcdef0");

    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("settings").style.display = "block";
};

/* ---------- BLE SENDER ---------- */
function send32(id, value) {
    if (!charWrite32) return;

    let b = new Uint8Array(5);
    b[0] = id; // Timer ID
    b[1] = value & 0xFF;
    b[2] = (value >> 8) & 0xFF;
    b[3] = (value >> 16) & 0xFF;
    b[4] = (value >> 24) & 0xFF;

    lastSent[id] = value;
    
    charWrite32.writeValue(b);
}

/* ---------- SLIDER ---------- */
document.getElementById("sliderA").oninput = e => {
    const v = Number(e.target.value);
    document.getElementById("valueA").innerText = v;
    send32(2, v);
};

/* ---------- PICKER LOGIK ---------- */

function setupPicker(element, max, callback) {

    // Spacer oben
    let topSpace = document.createElement("div");
    topSpace.className="item";
    topSpace.style.opacity=0;
    element.appendChild(topSpace);

    // Werte
    for (let i=0;i<=max;i++){
        let d=document.createElement("div");
        d.className="item";
        let s=document.createElement("span");
        s.innerText = i.toString().padStart(2,"0");
        d.appendChild(s);
        element.appendChild(d);
    }

    // Spacer unten
    let bottomSpace = topSpace.cloneNode(true);
    element.appendChild(bottomSpace);

    // Start bei 0
    element.scrollTop = ITEM_HEIGHT;

    element.addEventListener("scroll", ()=>{
        clearTimeout(element._t);
        element._t = setTimeout(()=>{

            let idx = Math.round(element.scrollTop / ITEM_HEIGHT);

            element.scrollTop = idx * ITEM_HEIGHT;

            let val = idx; // KEIN -1 ‚Üí Spacer einkalkuliert

            if (val < 0) val = 0;
            if (val > max) val = max;

            callback(val);

        },120);
    });
}

/* Timer 1 */
let t1 = {h:0, m:0, s:0};

setupPicker(document.getElementById("t1h"), 23, v=>{
    t1.h = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});
setupPicker(document.getElementById("t1m"), 59, v=>{
    t1.m = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});
setupPicker(document.getElementById("t1s"), 59, v=>{
    t1.s = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});

/* Timer 2 */
let t2 = {h:0, m:0, s:0};

setupPicker(document.getElementById("t2h"), 23, v=>{
    t2.h = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});
setupPicker(document.getElementById("t2m"), 59, v=>{
    t2.m = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});
setupPicker(document.getElementById("t2s"), 59, v=>{
    t2.s = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});

</script>

</body>
</html>
