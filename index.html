
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>M5Dial Konfigurator</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 420px;
        margin: auto;
        text-align: center;
    }

    /* Verbinden Button */
    #connectBtn {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        margin-top: 80px;
    }
    #connectBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    /* Nach Verbindung sichtbarer Bereich */
    #settings {
        display: none;
        margin-top: 30px;
        text-align: center;
    }

    /* Timer Block */
    .timer-block {
        margin-top: 30px;
        padding: 15px;
        border-radius: 12px;
        background: #f5f5f5;
    }

    .picker-row {
        display: flex;
        justify-content: space-between;
    }

    .picker {
        width: 30%;
        height: 150px;
        overflow-y: scroll;
        border-radius: 10px;
        border: 1px solid #bbb;
        background: #fff;
        position: relative;
        scroll-behavior: smooth;
    }

    .picker::-webkit-scrollbar {
        width: 6px;
    }

    .picker div {
        padding: 10px;
        font-size: 20px;
        height: 40px;
        line-height: 40px;
    }

    /* feste Auswahlzone */
    .picker::before {
        content: "";
        position: absolute;
        top: 55px;
        left: 0;
        width: 100%;
        height: 40px;
        border-top: 2px solid #4CAF50;
        border-bottom: 2px solid #4CAF50;
        pointer-events: none;
    }
</style>
</head>
<body>

<h1>M5Dial Einstellungen</h1>

<button id="connectBtn">üîó Ger√§t verbinden</button>

<div id="settings">

    <!-- Timer 1 -->
    <div class="timer-block">
        <h2>‚è± Timer 1</h2>
        <div class="picker-row">
            <div class="picker" id="t1h"></div>
            <div class="picker" id="t1m"></div>
            <div class="picker" id="t1s"></div>
        </div>
    </div>

    <!-- Timer 2 -->
    <div class="timer-block">
        <h2>‚è± Timer 2</h2>
        <div class="picker-row">
            <div class="picker" id="t2h"></div>
            <div class="picker" id="t2m"></div>
            <div class="picker" id="t2s"></div>
        </div>
    </div>

</div>

<script>
let charWrite32;

/* -------------------- BLE VERBINDUNG -------------------- */

document.getElementById("connectBtn").onclick = async () => {
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ name: "M5DialConfig" }],
            optionalServices: ["12345678-1234-5678-1234-56789abcdef0"]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("12345678-1234-5678-1234-56789abcdef0");

        // Neue Characteristic f√ºr 32bit Werte
        charWrite32 = await service.getCharacteristic("11111111-1234-5678-1234-56789abcdef0");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("settings").style.display = "block";

    } catch(e) {
        alert("Fehler: " + e);
    }
};


/* -------------------- TIMER PICKER -------------------- */

function buildPickerLoop(element, max) {
    // 3 Loops: 0..max
    for (let loop = 0; loop < 3; loop++) {
        for (let i = 0; i <= max; i++) {
            const d = document.createElement("div");
            d.innerText = i.toString().padStart(2, "0");
            element.appendChild(d);
        }
    }

    // Mitte als Startposition
    const middle = (max+1) * 1; 
    element.scrollTop = middle * 40;
}

function snapToCenter(element, max) {
    let index = Math.round(element.scrollTop / 40);
    element.scrollTop = index * 40;

    // Looping Bereich korrigieren
    const total = (max+1) * 3;

    if (index < (max+1)*0.5) element.scrollTop += (max+1)*40;
    if (index > (max+1)*2.5) element.scrollTop -= (max+1)*40;
}

async function send32(valueIndex, seconds) {
    if (!charWrite32) return;

    // 32 bit little-endian Buffer
    let b = new Uint8Array(5);
    b[0] = valueIndex;          // Kennung 0=timer1, 1=timer2, 2=valueA
    b[1] = seconds & 0xFF;
    b[2] = (seconds >> 8) & 0xFF;
    b[3] = (seconds >> 16) & 0xFF;
    b[4] = (seconds >> 24) & 0xFF;

    await charWrite32.writeValue(b);
}

function setupTimer(timerIdx, h, m, s) {
    const maxH = 23;
    const maxMS = 59;

    [h,m,s].forEach((el, i)=>{
        const max = (i === 0 ? maxH : maxMS);

        buildPickerLoop(el, max);

        el.addEventListener("scroll", ()=>{
            clearTimeout(el._timeout);
            el._timeout = setTimeout(()=> {
                snapToCenter(el, max);

                // Werte extrahieren
                const hour   = Math.round(h.scrollTop / 40) % (maxH+1);
                const minute = Math.round(m.scrollTop / 40) % 60;
                const second = Math.round(s.scrollTop / 40) % 60;

                const total = hour*3600 + minute*60 + second;

                send32(timerIdx, total);

            }, 150);
        });
    });
}

/* Timer 1 */
setupTimer(0,
    document.getElementById("t1h"),
    document.getElementById("t1m"),
    document.getElementById("t1s")
);

/* Timer 2 */
setupTimer(1,
    document.getElementById("t2h"),
    document.getElementById("t2m"),
    document.getElementById("t2s")
);

</script>

</body>
</html>
