
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>M5Dial Konfigurator</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 420px;
        margin: auto;
        text-align: center;
    }

    #connectBtn {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        margin-top: 80px;
    }

    #settings {
        display: none;
        margin-top: 30px;
    }

    /* TIMER UI */

    .timer-block {
        margin-top: 30px;
        padding: 15px;
        border-radius: 12px;
        background: #f5f5f5;
    }

    .picker-row {
        display: flex;
        justify-content: space-between;
    }

    /* WICHTIG: H√∂he = 3 Elemente √† 40px */
    .picker {
        width: 30%;
        height: 120px;         
        overflow-y: scroll;
        scrollbar-width: none;
        border: 1px solid #bbb;
        border-radius: 10px;
        background: #fff;
        position: relative;
    }

    .picker::-webkit-scrollbar {
        display: none;
    }

    .picker div {
        height: 40px;
        line-height: 40px;
        font-size: 22px;
    }

    /* FIXER Auswahlbereich */
    .picker::before {
        content: "";
        position: absolute;
        top: 40px;     /* Mitte Element 2 von 3 */
        left: 0;
        width: 100%;
        height: 40px;
        border-top: 2px solid #4CAF50;
        border-bottom: 2px solid #4CAF50;
        pointer-events: none;
        z-index: 10;
    }
</style>
</head>

<body>

<h1>M5Dial Einstellungen</h1>

<button id="connectBtn">üîó Ger√§t verbinden</button>

<div id="settings">

    <h2>Parameter A: <span id="valueA">0</span></h2>
    <input type="range" min="0" max="255" id="sliderA">

    <!-- TIMER 1 -->
    <div class="timer-block">
        <h2>‚è± Timer 1</h2>
        <div class="picker-row">
            <div class="picker" id="t1h"></div>
            <div class="picker" id="t1m"></div>
            <div class="picker" id="t1s"></div>
        </div>
    </div>

    <!-- TIMER 2 -->
    <div class="timer-block">
        <h2>‚è± Timer 2</h2>
        <div class="picker-row">
            <div class="picker" id="t2h"></div>
            <div class="picker" id="t2m"></div>
            <div class="picker" id="t2s"></div>
        </div>
    </div>

</div>

<script>
let charWrite32;

/* ---------------- BLE CONNECT ---------------- */

document.getElementById("connectBtn").onclick = async () => {
    const device = await navigator.bluetooth.requestDevice({
        filters: [{ name: "M5DialConfig" }],
        optionalServices: ["12345678-1234-5678-1234-56789abcdef0"]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("12345678-1234-5678-1234-56789abcdef0");

    charWrite32 = await service.getCharacteristic("11111111-1234-5678-1234-56789abcdef0");

    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("settings").style.display = "block";
};

/* ---------------- HELPER ---------------- */

function send32(id, value) {
    if (!charWrite32) return;
    let b = new Uint8Array(5);
    b[0] = id;
    b[1] = value & 0xFF;
    b[2] = (value >> 8) & 0xFF;
    b[3] = (value >> 16) & 0xFF;
    b[4] = (value >> 24) & 0xFF;
    charWrite32.writeValue(b);
}

/* ---------------- SLIDER ---------------- */

document.getElementById("sliderA").oninput = e => {
    const v = Number(e.target.value);
    document.getElementById("valueA").innerText = v;
    send32(2, v);
};

/* ---------------- TIMER LOGIK ---------------- */

function createWheel(el, max) {
    // 5 Wiederholungen f√ºr stabile Endlos-Schleife
    for (let r = 0; r < 5; r++) {
        for (let i = 0; i <= max; i++) {
            const d = document.createElement("div");
            d.innerText = i.toString().padStart(2, "0");
            el.appendChild(d);
        }
    }
    const block = max + 1;
    const midStart = block * 2;  
    el.scrollTop = midStart * 40;
}

function normalizeScroll(el, max) {
    const block = max + 1;
    const scrollBlock = Math.floor(el.scrollTop / (block * 40));

    if (scrollBlock < 1)
        el.scrollTop += block * 40;
    if (scrollBlock > 3)
        el.scrollTop -= block * 40;
}

function snap(el, max) {
    const idx = Math.round(el.scrollTop / 40);
    el.scrollTop = idx * 40;
}

function valueFrom(el, max) {
    const block = max + 1;
    const idx = Math.round(el.scrollTop / 40) % block;
    return idx;
}

function setupTimer(timerID, h, m, s) {
    createWheel(h, 23);
    createWheel(m, 59);
    createWheel(s, 59);

    [h,m,s].forEach((el, i) => {
        const max = (i === 0 ? 23 : 59);

        el.addEventListener("scroll", () => {
            clearTimeout(el._t);
            el._t = setTimeout(() => {
                normalizeScroll(el, max);
                snap(el, max);

                const hh = valueFrom(h, 23);
                const mm = valueFrom(m, 59);
                const ss = valueFrom(s, 59);

                const total = hh*3600 + mm*60 + ss;
                send32(timerID, total);

            }, 120);
        });
    });
}

setupTimer(0,
    document.getElementById("t1h"),
    document.getElementById("t1m"),
    document.getElementById("t1s")
);

setupTimer(1,
    document.getElementById("t2h"),
    document.getElementById("t2m"),
    document.getElementById("t2s")
);
</script>
</body>
</html>
