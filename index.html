
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>M5Dial Konfigurator</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 420px;
        margin: auto;
        text-align: center;
    }

    #connectBtn {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        margin-top: 80px;
    }

    #settings {
        display: none;
        margin-top: 30px;
    }

    .timer-block {
        margin-top: 30px;
        padding: 15px;
        border-radius: 12px;
        background: #f5f5f5;
    }

    .picker-row {
        display: flex;
        justify-content: space-between;
    }

    .picker {
        width: 30%;
        height: 150px;
        overflow-y: scroll;
        border-radius: 10px;
        border: 1px solid #bbb;
        background: #fff;
        position: relative;
        scroll-behavior: smooth;
    }

    .picker div {
        height: 40px;
        line-height: 40px;
        font-size: 24px;
    }

    .picker::-webkit-scrollbar { width: 0; }

    /* Auswahlbereich in der Mitte */
    .picker::before {
        content: "";
        position: absolute;
        top: 55px;
        left: 0;
        width: 100%;
        height: 40px;
        border-top: 2px solid #4CAF50;
        border-bottom: 2px solid #4CAF50;
        pointer-events: none;
    }

    input[type=range] {
        width: 100%;
    }
</style>
</head>
<body>

<h1>M5Dial Einstellungen</h1>

<button id="connectBtn">üîó Ger√§t verbinden</button>

<div id="settings">

    <h2>Parameter A: <span id="valueA">0</span></h2>
    <input type="range" min="0" max="255" id="sliderA">

    <!-- Timer 1 -->
    <div class="timer-block">
        <h2>‚è± Timer 1</h2>
        <div class="picker-row">
            <div class="picker" id="t1h"></div>
            <div class="picker" id="t1m"></div>
            <div class="picker" id="t1s"></div>
        </div>
    </div>

    <!-- Timer 2 -->
    <div class="timer-block">
        <h2>‚è± Timer 2</h2>
        <div class="picker-row">
            <div class="picker" id="t2h"></div>
            <div class="picker" id="t2m"></div>
            <div class="picker" id="t2s"></div>
        </div>
    </div>

</div>

<script>
let charWrite32 = null;

/* ---------- BLE CONNECT ---------- */

document.getElementById("connectBtn").onclick = async () => {
    const device = await navigator.bluetooth.requestDevice({
        filters: [{ name: "M5DialConfig" }],
        optionalServices: ["12345678-1234-5678-1234-56789abcdef0"]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("12345678-1234-5678-1234-56789abcdef0");

    charWrite32 = await service.getCharacteristic("11111111-1234-5678-1234-56789abcdef0");

    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("settings").style.display = "block";
};

/* ---------- HELFER ---------- */

function send32(id, value) {
    if (!charWrite32) return;
    let b = new Uint8Array(5);
    b[0] = id;
    b[1] = value & 0xFF;
    b[2] = (value >> 8) & 0xFF;
    b[3] = (value >> 16) & 0xFF;
    b[4] = (value >> 24) & 0xFF;
    charWrite32.writeValue(b);
}

/* ---------- SLIDER SENDEN ---------- */

document.getElementById("sliderA").oninput = e => {
    let v = Number(e.target.value);
    document.getElementById("valueA").innerText = v;
    send32(2, v);
};

/* ---------- TIMER PICKER ---------- */

function createLoop(element, max) {
    for (let loop=0; loop<3; loop++) {
        for (let i=0; i<=max; i++) {
            const d = document.createElement("div");
            d.innerText = i.toString().padStart(2,"0");
            element.appendChild(d);
        }
    }
    const mid = (max+1) * 1;
    element.scrollTop = mid * 40;
}

function fixLoop(element, max) {
    const block = max+1;
    const total = block * 3;
    let idx = Math.round(element.scrollTop / 40);

    // Zu nah an Anfang: nach unten versetzen
    if (idx < block*0.5)
        element.scrollTop += block * 40;

    // Zu nah am Ende: nach oben versetzen
    if (idx > block*2.5)
        element.scrollTop -= block * 40;
}

function snap(element, max) {
    let idx = Math.round(element.scrollTop / 40);
    element.scrollTop = idx * 40;
}

function setupTimer(timerID, h, m, s) {
    createLoop(h, 23);
    createLoop(m, 59);
    createLoop(s, 59);

    [h,m,s].forEach((el, i)=>{
        const max = (i==0 ? 23 : 59);

        el.addEventListener("scroll", ()=>{
            clearTimeout(el._t);
            el._t = setTimeout(()=>{

                fixLoop(el, max);
                snap(el, max);

                const hour = Math.round(h.scrollTop/40) % 24;
                const min  = Math.round(m.scrollTop/40) % 60;
                const sec  = Math.round(s.scrollTop/40) % 60;

                const total = hour*3600 + min*60 + sec;

                send32(timerID, total);

            },150);
        });
    });
}

setupTimer(0,
    document.getElementById("t1h"),
    document.getElementById("t1m"),
    document.getElementById("t1s")
);

setupTimer(1,
    document.getElementById("t2h"),
    document.getElementById("t2m"),
    document.getElementById("t2s")
);

</script>
</body>
</html>
