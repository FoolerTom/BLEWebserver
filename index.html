
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M5Dial Final Config</title>
<style>
    body {
        font-family: sans-serif;
        max-width: 420px;
        margin: auto;
        padding: 20px;
        text-align: center;
    }

    /* Verbinden-Button */
    #connectBtn {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        margin-top: 80px;
    }

    #settings {
        display: none;
        margin-top: 30px;
        text-align: center;
    }

    /* ---------- PICKER ---------- */
    .pickerWrapper {
        position: relative;
        width: 100px;
        height: 120px;  /* 3 × 40px */
    }
    .picker {
        width: 100%;
        height: 100%;
        overflow-y: scroll;
        scrollbar-width: none;
        overscroll-behavior: contain;
    }
    .picker::-webkit-scrollbar { display:none; }

    /* Fixer Marker */
    .centerMarker {
        position: absolute;
        left: 0;
        width: 100%;
        height: 40px;
        top: 40px; /* Mitte */
        border-top: 2px solid green;
        border-bottom: 2px solid green;
        pointer-events: none;
        z-index: 10;
    }

    /* Items (40px hoch, zentriert) */
    .item {
        height: 40px;
        position: relative;
    }
    .item span {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 22px;
    }

    .picker-row {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
    }

    /* Timer Block */
    .timer-block {
        background: #f0f0f0;
        border-radius: 12px;
        padding: 15px;
        margin-top: 25px;
    }

    .readout {
        margin-top: 8px;
        font-weight: 600;
    }
</style>
</head>

<body>

<h1>Nachtlicht Konfigurator</h1>

<button id="connectBtn">Gerät verbinden</button>

<div id="settings">

    <!-- SLIDER -->
    <h2>Helligkeit: <span id="valueA">–</span></h2>
    <input type="range" min="0" max="255" id="sliderA" style="width:90%;">

    <!-- TIMER 1 -->
    <div class="timer-block">
        <h2>An-Dauer</h2>
        <div class="picker-row">
            <div class="pickerWrapper">
                <div class="picker t1" id="t1h"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t1" id="t1m"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t1" id="t1s"></div>
                <div class="centerMarker"></div>
            </div>
        </div>
        <div class="readout" id="t1Readout">--:--:--</div>
    </div>

    <!-- TIMER 2 -->
    <div class="timer-block">
        <h2>Langsames Ausschalten</h2>
        <div class="picker-row">
            <div class="pickerWrapper">
                <div class="picker t2" id="t2h"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t2" id="t2m"></div>
                <div class="centerMarker"></div>
            </div>
            <div class="pickerWrapper">
                <div class="picker t2" id="t2s"></div>
                <div class="centerMarker"></div>
            </div>
        </div>
        <div class="readout" id="t2Readout">--:--:--</div>
    </div>

</div>

<script>
/* ================== BLE UUIDs ================== */
const SERVICE_UUID   = "12345678-1234-5678-1234-56789abcdef0";
const WRITE32_UUID   = "11111111-1234-5678-1234-56789abcdef0";
const NOTIFY_UUID    = "22222222-1234-5678-1234-56789abcdef0";

/* IDs:
   0 = Timer 1 (Sekunden total)
   1 = Timer 2 (Sekunden total)
   2 = Helligkeit (0..255)
*/

const ITEM_HEIGHT = 40;

let device = null;
let server = null;
let service = null;
let charWrite32 = null;
let notifyChar = null;
    
let keepAlive = null;

function startKeepAlive() {
    keepAlive = setInterval(() => {
        // send32 ignoriert ID=255
        send32(255, 0);
    }, 5000);
}

function stopKeepAlive() {
    if (keepAlive) clearInterval(keepAlive);
}


/* ---------- Utils ---------- */
function pad2(n){ return n.toString().padStart(2, "0"); }
function formatHMS(totalSeconds) {
    totalSeconds = Math.max(0, Math.floor(Number(totalSeconds) || 0));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
}

function showSettingsUI(show) {
    document.getElementById("settings").style.display = show ? "block" : "none";
    document.getElementById("connectBtn").style.display = show ? "none" : "inline-block";
}

/* ---------- Notify Handler (Single Source of Truth) ---------- */
function onNotify(event) {
    const data = event.target.value;
    const id   = data.getUint8(0);
    const val  = data.getUint32(1, true);

    // Konsole zur Diagnose
    // console.log("RX from M5Dial:", {id, val});

    if (id === 2) {
        // Helligkeit: nur hier setzen (keine optimistische Anzeige)
        document.getElementById("valueA").innerText = val;
        // Slider-Position an den bestätigten Wert anpassen
        document.getElementById("sliderA").value = val;
    } else if (id === 0) {
        // Timer 1
        document.getElementById("t1Readout").innerText = formatHMS(val);
        // Optional: Wenn du die Picker scroll-Position auf den bestätigten Wert setzen willst,
        // müsstest du hier h/m/s aus totalSeconds zurückrechnen und die Picker programmgesteuert setzen.
        // In diesem Code lassen wir die Picker-Position wie vom Benutzer, die Anzeige ist aber bestätigt & korrekt.
    } else if (id === 1) {
        // Timer 2
        document.getElementById("t2Readout").innerText = formatHMS(val);
    }
}


async function requestInitialValues() {
    // Trigger: M5Dial soll alle Werte zurücksenden
    // wir schicken eine spezielle ID=99
    send32(99, 0);
}

    
/* ---------- BLE: Gemeinsame Connect-Initialisierung ---------- */
async function setupGattAndUI(gattServer) {
    server = gattServer;
    service = await server.getPrimaryService(SERVICE_UUID);
    charWrite32 = await service.getCharacteristic(WRITE32_UUID);
    notifyChar  = await service.getCharacteristic(NOTIFY_UUID);

    await notifyChar.startNotifications();
    notifyChar.addEventListener("characteristicvaluechanged", onNotify);

    // Disconnect Handling
    device.addEventListener("gattserverdisconnected", onDisconnected);

    // UI schalten
    showSettingsUI(true);
    requestInitialValues();
}

/* ---------- Disconnect ---------- */
function onDisconnected() {
    // UI zurück zur Startansicht
    showSettingsUI(false);
}

/* ---------- Manuelles Verbinden (Button) ---------- */
async function connectBLE() {
    try {
        device = await navigator.bluetooth.requestDevice({
            filters: [{ name: "M5DialConfig" }],
            optionalServices: [SERVICE_UUID]
        });

        const gattServer = await device.gatt.connect();
        await setupGattAndUI(gattServer);
        startKeepAlive();
    } catch (err) {
        console.error("BLE connect failed:", err);
        showSettingsUI(false);
        stopKeepAlive();
    }
}

/* ---------- Auto-Reconnect beim Laden (wenn Browser das Gerät kennt) ---------- */
async function tryAutoReconnect() {
    try {
        if (!navigator.bluetooth.getDevices) {
            // Nicht verfügbar -> Button anzeigen
            showSettingsUI(false);
            return;
        }

        const knownDevices = await navigator.bluetooth.getDevices();
        // Suche das Gerät anhand des Namens
        const candidate = knownDevices.find(d => d && d.name === "M5DialConfig");

        if (!candidate) {
            showSettingsUI(false);
            return;
        }

        device = candidate;

        // Bereits verbunden?
        if (device.gatt && device.gatt.connected) {
            await setupGattAndUI(device.gatt);
            startKeepAlive();
            return;
        }

        // Verbinden ohne erneuten Dialog (da bereits erlaubt)
        const gattServer = await device.gatt.connect();
        await setupGattAndUI(gattServer);
        startKeepAlive();
    } catch (err) {
        console.warn("Auto-Reconnect nicht möglich:", err);
        showSettingsUI(false);
        stopKeepAlive();
    }
}

/* ---------- Sender ---------- */
function send32(id, value) {
    if (!charWrite32) return;
    // 1 Byte ID + 4 Byte LE
    const b = new Uint8Array(5);
    b[0] = id & 0xFF;
    b[1] =  value        & 0xFF;
    b[2] = (value >> 8)  & 0xFF;
    b[3] = (value >> 16) & 0xFF;
    b[4] = (value >> 24) & 0xFF;

    charWrite32.writeValue(b).catch(err => {
        console.error("writeValue failed:", err);
    });
}

/* ---------- Slider (kein sofortiges UI-Update) ---------- */
document.getElementById("sliderA").addEventListener("input", (e) => {
    const v = Number(e.target.value);
    // Anzeige NICHT hier ändern; nur senden.
    send32(2, v);
});

/* ---------- Picker-Setup ---------- */
function setupPicker(element, max, callback) {
    // Spacer oben
    let topSpace = document.createElement("div");
    topSpace.className="item";
    topSpace.style.opacity=0;
    element.appendChild(topSpace);

    // Werte
    for (let i=0;i<=max;i++){
        let d=document.createElement("div");
        d.className="item";
        let s=document.createElement("span");
        s.innerText = i.toString().padStart(2,"0");
        d.appendChild(s);
        element.appendChild(d);
    }

    // Spacer unten
    let bottomSpace = topSpace.cloneNode(true);
    element.appendChild(bottomSpace);

    // Start bei 0 (wie im Original)
    element.scrollTop = ITEM_HEIGHT;

    element.addEventListener("scroll", () => {
        clearTimeout(element._t);
        element._t = setTimeout(() => {
            let idx = Math.round(element.scrollTop / ITEM_HEIGHT);
            element.scrollTop = idx * ITEM_HEIGHT;

            let val = idx; // KEIN -1 → Spacer einkalkuliert (entspricht deinem Original)
            if (val < 0) val = 0;
            if (val > max) val = max;

            callback(val);
        }, 120);
    });
}

/* Timer 1 */
let t1 = {h:0, m:0, s:0};
setupPicker(document.getElementById("t1h"), 23, v=>{
    t1.h = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});
setupPicker(document.getElementById("t1m"), 59, v=>{
    t1.m = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});
setupPicker(document.getElementById("t1s"), 59, v=>{
    t1.s = v;
    send32(0, t1.h*3600 + t1.m*60 + t1.s);
});

/* Timer 2 */
let t2 = {h:0, m:0, s:0};
setupPicker(document.getElementById("t2h"), 23, v=>{
    t2.h = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});
setupPicker(document.getElementById("t2m"), 59, v=>{
    t2.m = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});
setupPicker(document.getElementById("t2s"), 59, v=>{
    t2.s = v;
    send32(1, t2.h*3600 + t2.m*60 + t2.s);
});

/* ---------- UI Events ---------- */
document.getElementById("connectBtn").addEventListener("click", connectBLE);

/* ---------- Start: Auto-Reconnect versuchen ---------- */
document.addEventListener("DOMContentLoaded", tryAutoReconnect);
</script>

</body>
</html>
