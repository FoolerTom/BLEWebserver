
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>M5Dial Konfigurator</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 420px;
        margin: auto;
        text-align: center;
    }

    /* Verbinden Button */
    #connectBtn {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        margin-top: 80px;
    }
    #connectBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    /* Inhalt nach Verbindung */
    #settings {
        display: none;
        margin-top: 40px;
        text-align: left;
    }

    /* Timer Container */
    .timer-block {
        margin-top: 30px;
        padding: 15px;
        border-radius: 12px;
        background: #f5f5f5;
    }

    .timer-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .picker-row {
        display: flex;
        justify-content: space-between;
    }

    .picker {
        width: 30%;
        height: 120px;
        overflow-y: scroll;
        border-radius: 10px;
        border: 1px solid #bbb;
        background: #fff;
        scrollbar-width: thin;
    }

    .picker div {
        padding: 10px;
        font-size: 20px;
    }

    .picker div.selected {
        background: #4CAF50;
        color: white;
        border-radius: 6px;
    }
</style>
</head>
<body>

<h1>M5Dial Einstellungen</h1>

<!-- Nur am Anfang sichtbar -->
<button id="connectBtn">üîó Ger√§t verbinden</button>

<!-- Inhalt nach BLE-Verbindung -->
<div id="settings">

    <h2>Parameter A: <span id="valueA">--</span></h2>
    <input type="range" min="0" max="255" id="sliderA">

    <!-- Timer 1 -->
    <div class="timer-block">
        <div class="timer-title">‚è± Timer 1</div>
        <div class="picker-row">
            <div class="picker" id="t1h"></div>
            <div class="picker" id="t1m"></div>
            <div class="picker" id="t1s"></div>
        </div>
    </div>

    <!-- Timer 2 -->
    <div class="timer-block">
        <div class="timer-title">‚è± Timer 2</div>
        <div class="picker-row">
            <div class="picker" id="t2h"></div>
            <div class="picker" id="t2m"></div>
            <div class="picker" id="t2s"></div>
        </div>
    </div>

</div>

<script>
let paramWrite, paramNotify;

// BLE Verbinden
document.getElementById("connectBtn").onclick = async () => {
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ name: "M5DialConfig" }],
            optionalServices: ["12345678-1234-5678-1234-56789abcdef0"]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("12345678-1234-5678-1234-56789abcdef0");

        paramWrite = await service.getCharacteristic("11111111-1234-5678-1234-56789abcdef0");
        paramNotify = await service.getCharacteristic("22222222-1234-5678-1234-56789abcdef0");

        await paramNotify.startNotifications();
        paramNotify.addEventListener("characteristicvaluechanged", e => {
            const value = e.target.value.getUint8(0);
            document.getElementById("valueA").innerText = value;
            document.getElementById("sliderA").value = value;
        });

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("settings").style.display = "block";

    } catch (e) {
        alert("Fehler: " + e);
    }
};

// Slider ‚Üí M5Dial
document.getElementById("sliderA").oninput = async ev => {
    const v = Number(ev.target.value);
    document.getElementById("valueA").innerText = v;
    if (paramWrite) await paramWrite.writeValue(new Uint8Array([v]));
};

//
// ---------- TIMER PICKER LOGIK ----------
//
function buildPicker(element, max) {
    for (let i = 0; i <= max; i++) {
        const d = document.createElement("div");
        d.innerText = i.toString().padStart(2, "0");
        element.appendChild(d);
    }
}

// Picker initialisieren
["t1h","t2h"].forEach(id => buildPicker(document.getElementById(id), 23));
["t1m","t2m","t1s","t2s"].forEach(id => buildPicker(document.getElementById(id), 59));

// Scroll-Auswahl markieren + Sekunden senden
function setupPicker(timerName, element, unit) {
    element.addEventListener("scroll", () => {
        const index = Math.round(element.scrollTop / 40);
        [...element.children].forEach((c,i) => c.classList.toggle("selected", i === index));

        updateTimerSeconds(timerName);
    });
}

// Timer Sekunden berechnen + BLE senden
async function updateTimerSeconds(timer) {
    const h = parseInt(document.querySelector(`#${timer}h .selected`)?.innerText || "0");
    const m = parseInt(document.querySelector(`#${timer}m .selected`)?.innerText || "0");
    const s = parseInt(document.querySelector(`#${timer}s .selected`)?.innerText || "0");

    const total = h*3600 + m*60 + s;

    console.log(timer + " ‚Üí " + total + " Sekunden");

    if (paramWrite) {
        await paramWrite.writeValue(new Uint8Array([total & 0xFF]));
    }
}

// Picker verbinden
setupPicker("t1", document.getElementById("t1h"));
setupPicker("t1", document.getElementById("t1m"));
setupPicker("t1", document.getElementById("t1s"));

setupPicker("t2", document.getElementById("t2h"));
setupPicker("t2", document.getElementById("t2m"));
setupPicker("t2", document.getElementById("t2s"));
</script>

</body>
</html>
